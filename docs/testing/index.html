<!doctype html><html><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon.svg><meta name=color-scheme content="only dark"><meta property="og:title" content="Running Tests"><meta property="og:description" content="A walkthrough of Odin&rsquo;s test runner."><meta property="og:type" content="article"><meta property="og:url" content="https://odin-lang.org/docs/testing/"><meta property="og:image" content="https://odin-lang.org/images/logo-slim.png"><link rel=stylesheet href=https://odin-lang.org/scss/custom.min.css><link rel=stylesheet href=/lib/highlight/styles/github-dark.min.css><script src=/lib/highlight/highlight.min.js></script><script src=/lib/highlight/languages/x86asm.min.js></script><script>hljs.registerLanguage("odin",function(e){return{aliases:["odin","odinlang","odin-lang"],keywords:{keyword:"auto_cast bit_field bit_set break case cast context continue defer distinct do dynamic else enum fallthrough for foreign if import in map matrix not_in or_else or_return package proc return struct switch transmute type_of typeid union using when where",literal:"true false nil",built_in:"abs align_of cap clamp complex conj expand_to_tuple imag jmag kmag len max min offset_of quaternion real size_of soa_unzip soa_zip swizzle type_info_of type_of typeid_of"},illegal:"</",contains:[e.C_LINE_COMMENT_MODE,e.C_BLOCK_COMMENT_MODE,{className:"string",variants:[e.QUOTE_STRING_MODE,{begin:"'",end:"[^\\\\]'"},{begin:"`",end:"`"}]},{className:"number",variants:[{begin:e.C_NUMBER_RE+"[ijk]",relevance:1},e.C_NUMBER_MODE]}]}})</script><script>hljs.highlightAll()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-67516878-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-67516878-2")</script><link href=/css/style.css rel=stylesheet><title>Running Tests | Odin Programming Language </title><link rel=alternate type=application/rss+xml href=https://odin-lang.org//categories/newsletter/index.xml title="Odin Newsletter"><body data-bs-spy=scroll data-bs-target=#TOC data-bs-offset=0 tabindex=0><script>window.localStorage.getItem("theme")||window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(window.localStorage.setItem("theme","dark"),document.body.classList.add("dark-mode")),window.localStorage.getItem("theme")==="dark"&&document.body.classList.add("dark-mode");function toggleDarkMode(){document.body.classList.toggle("dark-mode")?window.localStorage.setItem("theme","dark"):window.localStorage.setItem("theme","light")}</script><header class=sticky-top><nav class="navbar navbar-expand-lg navbar-dark bg-primary odin-menu"><div class=container-xxl><a class=navbar-brand href=/><img src=/logo.svg height=30 alt=Odin id=navbar-logo>
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#odin-navbar-content aria-controls=odin-navbar-content aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=odin-navbar-content><ul class="navbar-nav ms-md-auto"><li class=nav-item><a class=nav-link href=/>Home</a></li><li class=nav-item><a class="nav-link active" href=/docs aria-current=page>Docs</a></li><li class=nav-item><a class=nav-link href=https://pkg.odin-lang.org/>Packages</a></li><li class=nav-item><a class=nav-link href=/news>News</a></li><li class=nav-item><a class=nav-link href=/showcase>Showcase</a></li><li class=nav-item><a class=nav-link href=https://forum.odin-lang.org>Forum</a></li><li class=nav-item><a class=nav-link href=/community>Community</a></li><li class=nav-item><a class=nav-link href=https://github.com/odin-lang/Odin target=_blank>GitHub</a></li><li class=nav-item><a class="nav-link btn-dark-mode" onclick=toggleDarkMode() title="Toggle Light/Dark Mode"><span class=dark-mode-appearance>Appearance:</span><svg fill="#fff" id="dark-mode-icon" viewBox="0 0 384 512"><path d="M223.5 32C1e2 32 0 132.3.0 256S1e2 480 223.5 480c60.6.0 115.5-24.2 155.8-63.4 5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6-96.9.0-175.5-78.8-175.5-176 0-65.8 36-123.1 89.3-153.3 6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"/></svg><svg fill="#fff" id="light-mode-icon" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8M8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0m0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13m8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5M3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8m10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0m-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0m9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707M4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708"/></svg></button></a></li></ul></div></div></nav></header><main><div class=container-xxl><div class="row odin-main"><nav class="col-lg-2 odin-sidebar-border navbar-light"><div class="sticky-top odin-below-navbar py-3"><ul class="nav nav-pills d-flex flex-column"><li class=nav-item><a class=nav-link href=/docs/install/>Getting Started</a></li><li class=nav-item><a class=nav-link href=/docs/overview/>Overview</a></li><li class=nav-item><a class=nav-link href=/docs/faq/>FAQ</a></li><li class=nav-item><a class=nav-link href=/docs/demo/>Demo File</a></li><li class=nav-item><a class=nav-link href=/docs/packages/>Packages</a></li><li class=nav-item><a class=nav-link href=/docs/examples/>Examples</a></li><li class=nav-item><a class=nav-link href=/docs/odin-book/>Books [External]</a></li><li class=nav-item><a class=nav-link href=/docs/nightly/>Nightly Builds</a></li><li class=nav-item><a class="nav-link active" href=/docs/testing/ aria-current=page>Running Tests</a></li></ul></div></nav><article class="col-lg-8 p-4"><header><nav aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=/docs>Docs</a></li><li class=breadcrumb-item><a href=/docs/testing>Testing</a></li></ol><h1>Running Tests</h1></header><div class=odin-article><h2 id=the-test-runner>The Test Runner <a class=text-decoration-none href=#the-test-runner>#</a></h2><p>Odin comes with a powerful test runner.</p><h3 id=features>Features <a class=text-decoration-none href=#features>#</a></h3><ul><li>Multi-threaded by default.</li><li>Memory usage tracking: tests will report leaks and bad frees when complete.</li><li>Logging: each test is given a thread-safe logging interface.</li><li>Cancel early with <code>CTRL-C</code>.</li><li>Gracefully handles segmentation violations, asserts, and panics from within tests.</li><li>End-of-run summary with a listing of failed tests.</li><li>ANSI-colored animated progress report.</li><li>Test-wide per-run random seed.</li><li>Option to copy failed tests to clipboard.</li></ul><h2 id=what-are-tests>What are tests? <a class=text-decoration-none href=#what-are-tests>#</a></h2><p>If you&rsquo;re unfamiliar with the concept of tests in programming, they are procedures designed to see if expectations are met. They are far better than manually trying out things, especially as time goes on and more features (or bugs!) are introduced to programs and libraries you develop (or depend on!)</p><p>It is a fully automated process, capable of ensuring that from the day you wrote the test until many months or even years later, that the expectations you initially laid out are still met.</p><p>A collection of tests is often called a test suite. In Odin, we run tests by using the <code>odin test</code> command to compile and run our test suites. An Odin test suite is no different from a regular Odin program, and a test itself is no different from an Odin procedure.</p><p>Let&rsquo;s start with a small example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-odin data-lang=odin><span style=display:flex><span><span style=color:#f92672>package</span> tests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;core:testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@(test)</span>
</span></span><span style=display:flex><span>my_test <span style=color:#f92672>::</span> <span style=color:#66d9ef>proc</span>(t<span style=color:#f92672>:</span> <span style=color:#f92672>^</span>testing.T) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// This tests succeeds by default.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>All individual tests require the <a href=/docs/overview/#test><code>@(test)</code> attribute</a>. This is how the compiler knows which ones to send to the test runner. They also must accept one and only one argument: <code>^testing.T</code>. It can be named anything you want it to be, but by convention, virtually every test uses <code>t</code>.</p><p><code>^testing.T</code> is a pointer to a special <code>struct</code> defined by the <code>core:testing</code> package. We&rsquo;ll talk more about that later.</p><h4 id=expectations>Expectations <a class=text-decoration-none href=#expectations>#</a></h4><p>Let&rsquo;s make our test do something.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-odin data-lang=odin><span style=display:flex><span><span style=color:#f92672>package</span> tests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;core:testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@(test)</span>
</span></span><span style=display:flex><span>my_test <span style=color:#f92672>::</span> <span style=color:#66d9ef>proc</span>(t<span style=color:#f92672>:</span> <span style=color:#f92672>^</span>testing.T) {
</span></span><span style=display:flex><span>    n <span style=color:#f92672>:=</span> <span style=color:#a6e22e>2</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check if `n` is the expected value of `4`.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// If not, fail the test with the provided message.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    testing.expect(t, n <span style=color:#f92672>==</span> <span style=color:#a6e22e>4</span>, <span style=color:#e6db74>&#34;2 + 2 failed to equal 4.&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This test will also always succeed, but at least it earned it by testing some condition. <code>expect</code> is the heart of how tests are measured. There are a few other procedures that can be used to encode our expectation, and all of them take the <code>^testing.T</code> value that we are provided in the argument to every test case. Let&rsquo;s try <code>expect_value</code>.</p><p>How about a less contrived example?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-odin data-lang=odin><span style=display:flex><span><span style=color:#f92672>package</span> tests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;core:testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Add up all the rune values in the string.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>my_very_simple_hash_function <span style=color:#f92672>::</span> <span style=color:#66d9ef>proc</span>(str<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>-&gt;</span> (result<span style=color:#f92672>:</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> r <span style=color:#66d9ef>in</span> str {
</span></span><span style=display:flex><span>        result <span style=color:#f92672>+=</span> <span style=color:#66d9ef>cast</span>(<span style=color:#66d9ef>int</span>)r
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@(test)</span>
</span></span><span style=display:flex><span>my_test <span style=color:#f92672>::</span> <span style=color:#66d9ef>proc</span>(t<span style=color:#f92672>:</span> <span style=color:#f92672>^</span>testing.T) {
</span></span><span style=display:flex><span>    hash <span style=color:#f92672>:=</span> my_very_simple_hash_function(<span style=color:#e6db74>&#34;hellope&#34;</span>)
</span></span><span style=display:flex><span>    testing.expect_value(t, hash, <span style=color:#a6e22e>745</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Normally, you would not have the procedures you&rsquo;re testing also be in the test file; they would be imported from a package elsewhere. This is just for the sake of example.</p><p>Because the numeric values of each rune in <code>"hellope"</code> add up to <code>745</code>, this test will pass, and it did some real, useful work. Now, if <code>my_very_simple_hash_function</code> is ever changed to where its output does not meet this expectation in this case, the test will fail, and you&rsquo;ll be given an informative error message.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>[ERROR] --- [2024-06-10 17:45:38] [tests.odin:16:my_test()] expected 745, got 752
</span></span></code></pre></div><p><strong>Note:</strong> A test can have multiple <code>expect</code>ations, not just one. You can use any combination of the procedures documented here.</p><h4 id=conclusion>Conclusion <a class=text-decoration-none href=#conclusion>#</a></h4><p>Hopefully by now, you can see the usefulness in having tests, especially for large, non-trivial programs and libraries. They can save you great amounts of time, catch subtle bugs, and encode your expectations in a format that is objectively <em>testable</em>.</p><h2 id=output-examples>Output Examples <a class=text-decoration-none href=#output-examples>#</a></h2><p>When starting the test runner with the default options, you&rsquo;ll be given a few messages like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>[INFO ] --- [2024-06-10 17:45:38] Starting test runner with 1 thread. Set with -define:ODIN_TEST_THREADS=n.
</span></span><span style=display:flex><span>[INFO ] --- [2024-06-10 17:45:38] The random seed sent to every test is: 200916733232426. Set with -define:ODIN_TEST_RANDOM_SEED=n.
</span></span><span style=display:flex><span>[INFO ] --- [2024-06-10 17:45:38] Memory tracking is enabled. Tests will log their memory usage if there&#39;s an issue.
</span></span><span style=display:flex><span>[INFO ] --- [2024-06-10 17:45:38] &lt; Final Mem/ Total Mem&gt; &lt;  Peak Mem&gt; (#Free/Alloc) :: [package.test_name]
</span></span></code></pre></div><p>The first line tells you how many threads your CPU is utilizing. Each test will run on its own thread, and the runner will parallelize the work across the available threads.
The second line tells you what the <a href=/docs/testing/#tseed>random seed</a> is for this run. It is different for every run, but the same seed is sent to every test. The third line reports the state of memory tracking. This is on by default and will stay quiet unless there&rsquo;s an issue, but <a href=/docs/testing/#compile-time-options>this can be changed</a>. The fourth line explains what the format of the memory tracker&rsquo;s output will be like.</p><h3 id=the-memory-tracker>The Memory Tracker <a class=text-decoration-none href=#the-memory-tracker>#</a></h3><p>Every test has its memory usage monitored by default, including any procedures it calls that may allocate memory. This makes for a fast and easy way to test a package in development for any issues.</p><p>For example, if you have a leaky test:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>[WARN ] --- [2024-06-10 18:08:15] &lt;   1.00KiB/   1.00KiB&gt; &lt;   1.00KiB&gt; (    0/    1) :: tests.my_test
</span></span><span style=display:flex><span>        +++ leak    1.00KiB @ 0x7FD235C00048 [tests.odin:8:my_test()]
</span></span></code></pre></div><p>This test leaked exactly one kilobyte, which is to say that it failed to free the memory in question. It never used more than that one kilobyte, and it had zero frees and one allocation. The next line down, we can see the exact position of where the leak occurred and where the memory was stored.</p><p>Let&rsquo;s look at another type of memory issue.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>[WARN ] --- [2024-06-10 18:11:23] &lt;        0B/        8B&gt; &lt;        8B&gt; (    1/    1) :: tests.my_test
</span></span><span style=display:flex><span>        +++ bad free        @ 0x7136A2600048 [tests.odin:10:my_test()]
</span></span></code></pre></div><p>This test had a bad free, which is where <code>free</code> or <code>delete</code> is used on an invalid pointer. This pointer may have already been freed (in this case, it&rsquo;s called a double free) or it may not have even been a valid place where allocated memory was stored to begin with.</p><p>If you find these memory tracking facilities intriguing, know that they are not special to just the test runner. Odin has a <a href=https://pkg.odin-lang.org/core/mem/#Tracking_Allocator><code>Tracking_Allocator</code></a> in the <code>core:mem</code> package upon which all of this is built. Custom allocators are available to every Odin program.</p><h2 id=api-overview>API Overview <a class=text-decoration-none href=#api-overview>#</a></h2><p>The <code>T</code> given to every test is used in the testing API to indicate which test is speaking to the runner. It is used as the first argument to every one of the procedures in <code>core:testing</code>.</p><h3 id=logging>Logging <a class=text-decoration-none href=#logging>#</a></h3><p>Tests in Odin use the very same <a href=https://pkg.odin-lang.org/core/log/>logging procedures</a> made available to regular programs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-odin data-lang=odin><span style=display:flex><span><span style=color:#f92672>package</span> tests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;core:log&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;core:testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@(test)</span>
</span></span><span style=display:flex><span>my_test <span style=color:#f92672>::</span> <span style=color:#66d9ef>proc</span>(t<span style=color:#f92672>:</span> <span style=color:#f92672>^</span>testing.T) {
</span></span><span style=display:flex><span>	log.info(<span style=color:#e6db74>&#34;Hellope!&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>[INFO ] --- [2024-06-10 18:01:24] [tests.odin:8:my_test()] Hellope!
</span></span></code></pre></div><p>There are five different levels of logging if you need to report extra information during a test. By default, the test runner has its lowest logging level set to <code>info</code> but <a href=/docs/testing/#compile-time-options>this can be changed</a>. That means you can filter out messages below a certain level.</p><p>For instance, if you only want to see warnings and above, you could use <code>-define:ODIN_TEST_LOG_LEVEL=warning</code> on the command line.</p><p>It should be noted that if any <code>error</code> or <code>fatal</code>-level log message is raised during a test, the test will be treated as if it had failed, even if all expectations were met.</p><h3 id=testingcleanup><code>testing.cleanup</code> <a class=text-decoration-none href=#testingcleanup>#</a></h3><p><code>cleanup</code> is a tool to use if you absolutely must have some procedure run when a test fails catastrophically, such as a signal being raised, a bounds-checking error, an <code>assert</code> failure, a <code>panic</code>, a memory violation, and so on.</p><p>The idiomatic way to perform cleanup procedures in Odin is to use a <a href=/docs/overview/#defer-statement><code>defer</code> statement</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-odin data-lang=odin><span style=display:flex><span><span style=color:#f92672>package</span> tests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;core:testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@(test)</span>
</span></span><span style=display:flex><span>my_test <span style=color:#f92672>::</span> <span style=color:#66d9ef>proc</span>(t<span style=color:#f92672>:</span> <span style=color:#f92672>^</span>testing.T) {
</span></span><span style=display:flex><span>	i <span style=color:#f92672>:=</span> <span style=color:#66d9ef>new</span>(<span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// This test won&#39;t leak any memory, because `free(i)` will be run at the end of this scope.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>defer</span> free(i)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ... do some work ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>With tests, we have a way to perform emergency procedures in the event of a crash.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-odin data-lang=odin><span style=display:flex><span><span style=color:#f92672>package</span> tests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;core:os&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;core:testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@(test)</span>
</span></span><span style=display:flex><span>my_test <span style=color:#f92672>::</span> <span style=color:#66d9ef>proc</span>(t<span style=color:#f92672>:</span> <span style=color:#f92672>^</span>testing.T) {
</span></span><span style=display:flex><span>	fd, open_error <span style=color:#f92672>:=</span> os.open(<span style=color:#e6db74>&#34;test_data&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#960050;background-color:#1e0010>!</span>testing.expect_value(t, open_error, os.ERROR_NONE) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	testing.cleanup(t, <span style=color:#66d9ef>proc</span> (raw_handle<span style=color:#f92672>:</span> <span style=color:#66d9ef>rawptr</span>) {
</span></span><span style=display:flex><span>		handle <span style=color:#f92672>:=</span> <span style=color:#66d9ef>cast</span>(<span style=color:#f92672>^</span>os.Handle)raw_handle
</span></span><span style=display:flex><span>		os.close(handle<span style=color:#f92672>^</span>)
</span></span><span style=display:flex><span>	}, <span style=color:#f92672>&amp;</span>fd)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	some_value <span style=color:#f92672>:=</span> <span style=color:#a6e22e>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ... later on somewhere else ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	assert(some_value <span style=color:#f92672>==</span> <span style=color:#a6e22e>13</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If we didn&rsquo;t use <code>cleanup</code>, the <code>fd</code> file handle would still be open, because <code>defer</code> statements are not run if the thread panics.</p><p>However, for almost all situations, you should be fine trusting in <code>defer</code>; <code>cleanup</code> is for those rare times when you have a particularly unstable test case and need to clean it up afterwards.</p><p>It should be noted that, if the test panics or times out, <code>cleanup</code> runs with greater privilege in the main thread, to preserve the state of the test&rsquo;s memory. With this in mind, all <code>cleanup</code> procedures must not, under any circumstance: fail an assertion, fail a bounds check, access invalid memory, panic, or raise a signal of any sort. Otherwise, they will take down the entire test runner.</p><p><strong>Note:</strong> Even if a test fails catastrophically and doesn&rsquo;t clean up any of the memory it used, the test runner equips each test thread with its own custom allocator that is wiped clean at the start of a new test. You do not need to worry about memory leaks in completed tests causing issues later on.</p><h3 id=testingexpect><code>testing.expect</code> <a class=text-decoration-none href=#testingexpect>#</a></h3><p>This procedure allows for a simple check of a boolean value to determine test success or failure, with an optional message displayed if the boolean was false.</p><h3 id=testingexpectf><code>testing.expectf</code> <a class=text-decoration-none href=#testingexpectf>#</a></h3><p>This procedure is like <code>expect</code>, except the message can be formatted with additional values, much like <code>fmt.printf</code> or <code>log.infof</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-odin data-lang=odin><span style=display:flex><span><span style=color:#f92672>package</span> tests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;core:testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@(test)</span>
</span></span><span style=display:flex><span>my_test <span style=color:#f92672>::</span> <span style=color:#66d9ef>proc</span>(t<span style=color:#f92672>:</span> <span style=color:#f92672>^</span>testing.T) {
</span></span><span style=display:flex><span>	value <span style=color:#f92672>:=</span> <span style=color:#a6e22e>32</span>
</span></span><span style=display:flex><span>	testing.expectf(t, <span style=color:#66d9ef>false</span>, <span style=color:#e6db74>&#34;Hellope! The value is: %i&#34;</span>, value)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This will result in the test failing with the message formatted in the logs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>[ERROR] --- [2024-06-15 07:18:03] [tests.odin:8:my_test()] Hellope! The value is: 32
</span></span></code></pre></div><h3 id=testingexpect_value><code>testing.expect_value</code> <a class=text-decoration-none href=#testingexpect_value>#</a></h3><p>This is the easiest procedure for checking one value against another. It makes an error message for you based on your inputs, if the check fails.</p><h3 id=testingset_fail_timeout><code>testing.set_fail_timeout</code> <a class=text-decoration-none href=#testingset_fail_timeout>#</a></h3><p>This procedure is handy if you expect some work that you&rsquo;ll do in a test may take a long time, and you don&rsquo;t want it to run over a certain limit, or if you&rsquo;re aware of an edge case where an infinite loop may happen. Provide it with a <code>time.Duration</code> from <a href=https://pkg.odin-lang.org/core/time/><code>core:time</code></a>, such as <code>5 * time.Second</code>, and the test will be forced to stop if it takes longer than that duration.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-odin data-lang=odin><span style=display:flex><span><span style=color:#f92672>package</span> tests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;core:testing&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;core:time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@(test)</span>
</span></span><span style=display:flex><span>my_test <span style=color:#f92672>::</span> <span style=color:#66d9ef>proc</span>(t<span style=color:#f92672>:</span> <span style=color:#f92672>^</span>testing.T) {
</span></span><span style=display:flex><span>	testing.set_fail_timeout(t, <span style=color:#a6e22e>5</span> <span style=color:#f92672>*</span> time.Second)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> i <span style=color:#f92672>:=</span> <span style=color:#a6e22e>0</span>; i <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>0</span>; i <span style=color:#f92672>+=</span> <span style=color:#a6e22e>1</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// An infinite loop.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=testingfail><code>testing.fail</code> <a class=text-decoration-none href=#testingfail>#</a></h3><p>This is a quick and simple way to make a test fail. Ideally, prefer one of the <code>expect*</code> procedures if you can, or use <code>log.error</code> with an informative failure reason.</p><h3 id=testingfail_now><code>testing.fail_now</code> <a class=text-decoration-none href=#testingfail_now>#</a></h3><p><code>fail_now</code> will cause not only the test to fail, but for all further execution in that thread to stop. This is what is called a divergent procedure, much like <code>assert</code> or <code>panic</code>. It is for when you absolutely must stop a test, no matter what.</p><h3 id=tseed><code>T.seed</code> <a class=text-decoration-none href=#tseed>#</a></h3><p>This is where the random seed for each test&rsquo;s generator goes. It is different for every run but the same across all tests in that run. By default, the random number generator is already setup for you, but if you need to reset the generator back to its initial state, a call to <code>rand.reset(t.seed)</code> will do it.</p><p>Having an explicit and shared random seed for each run helps keep tests that rely on random procedures to be more deterministic, in the event of a test failure due to particular random seed.</p><h2 id=separating-tests>Separating Tests <a class=text-decoration-none href=#separating-tests>#</a></h2><p>There&rsquo;s the question of how much or how little to put into a test, as far as number and variety of different expectations go. This is somewhat a matter of taste, but it can be much easier to pin down a failure point when tests cover small or atomic portions of a program or library. The usefulness of a <code>test_everything</code> proc full of <code>expect</code>s is questionable, for example.</p><p>Keep in mind the multi-threaded nature of the test runner. Too little parallelizable work, and any extra cores go to waste.</p><h2 id=multiple-packages>Multiple Packages <a class=text-decoration-none href=#multiple-packages>#</a></h2><p>Normally, the test runner only compiles with the <code>@(test)</code> procedures in the specific package and not any of the imported packages.
You can run tests on every <code>@(test)</code> procedure by using the <code>-all-packages</code> option on the command-line.</p><p>Given a directory structure like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>\____ src/
</span></span><span style=display:flex><span> \___ tests/
</span></span><span style=display:flex><span>      \______ foo/
</span></span><span style=display:flex><span>       \_____ bar/
</span></span><span style=display:flex><span>        \____ gadgets/
</span></span><span style=display:flex><span>         \___ widgets/
</span></span></code></pre></div><p>You can keep a file named <code>tests.odin</code> at the <code>tests/</code> level like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-odin data-lang=odin><span style=display:flex><span><span style=color:#f92672>package</span> tests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@require</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;foo&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@require</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;bar&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@require</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;gadgets&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@require</span> <span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;widgets&#34;</span>
</span></span></code></pre></div><p>Then run <code>odin test tests/ -all-packages</code> to run every <code>@(test)</code> procedure in the subdirectories.</p><h2 id=compile-time-options>Compile-Time Options <a class=text-decoration-none href=#compile-time-options>#</a></h2><p>There are several compile-time options that help you tailor the test runner&rsquo;s execution to your preferences.
The test runner is written in Odin itself, so these are <a href=/docs/overview/#configidentifer-default><code>#config</code> options</a>, as opposed to regular flags.</p><ul><li><code>ODIN_TEST_THREADS=&lt;n></code> sets how many threads to use. Set to <code>0</code> to use the number of cores available.</li><li><code>ODIN_TEST_TRACK_MEMORY=false</code> turns off memory tracking. It is on by default.</li><li><code>ODIN_TEST_ALWAYS_REPORT_MEMORY=true</code> turns on memory usage reporting for all cases. By default, only issues with memory usage are reported, such as leaks or bad frees.</li><li><code>ODIN_TEST_THREAD_MEMORY=&lt;bytes></code> sets precisely how many bytes each thread is allocated to start with. Normally, each thread is allocated 4 megabytes of memory and may request additional memory.</li><li><code>ODIN_TEST_NAMES=&lt;package.test_name,test_name,...></code> sets which tests to run by name. Good for selecting a few out of one package.</li><li><code>ODIN_TEST_FANCY=false</code> turns off the ANSI-colored animated progress report. It is on by default.</li><li><code>ODIN_TEST_CLIPBOARD=true</code> will make the test runner copy the names of any failed tests to your clipboard at the end of the run, if your terminal supports OSC 52.</li><li><code>ODIN_TEST_PROGRESS_WIDTH=&lt;n columns></code> sets how wide the progress bars should be. Set it to <code>0</code> to cap it to the number of tests per package.</li><li><code>ODIN_TEST_RANDOM_SEED=&lt;n></code> sets the random seed that will be sent to every test. By default, a seed is picked when the test runner starts. This option is good if you encounter an issue that only occurs under certain random conditions with a particular seed.</li><li><code>ODIN_TEST_LOG_LEVEL=&lt;debug|info|warning|error|fatal></code> sets the lowest log level for the logger, allowing you to filter out messages below a certain level.</li><li><code>ODIN_TEST_SHORT_LOGS=true</code> keeps the log messages short and tidy by omitting the date & time information, as well as what procedure emitted the log message. File and line information is still provided.</li></ul><p>These options are entered like so on the command-line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>odin test . -define:ODIN_TEST_SHORT_LOGS=true
</span></span></code></pre></div><h2 id=final-notes>Final Notes <a class=text-decoration-none href=#final-notes>#</a></h2><p>The test runner was written to be easily-readable and maintainable, given its duty in ensuring stability. If you&rsquo;re curious about how to write a multi-threaded program that handles runtime exceptions, memory tracking, and inter-thread communication with thread-safe logging, it makes for a fine example.</p><p>The files can be found under <code>core/testing/</code>.</p></div></article><div id=TOC class="col-lg-2 odin-toc-border"><div class="sticky-top odin-below-navbar py-3"><nav id=TableOfContents><ul><li><a href=#the-test-runner>The Test Runner</a><ul><li><a href=#features>Features</a></li></ul></li><li><a href=#what-are-tests>What are tests?</a><ul><li><ul><li><a href=#expectations>Expectations</a></li><li><a href=#conclusion>Conclusion</a></li></ul></li></ul></li><li><a href=#output-examples>Output Examples</a><ul><li><a href=#the-memory-tracker>The Memory Tracker</a></li></ul></li><li><a href=#api-overview>API Overview</a><ul><li><a href=#logging>Logging</a></li><li><a href=#testingcleanup><code>testing.cleanup</code></a></li><li><a href=#testingexpect><code>testing.expect</code></a></li><li><a href=#testingexpectf><code>testing.expectf</code></a></li><li><a href=#testingexpect_value><code>testing.expect_value</code></a></li><li><a href=#testingset_fail_timeout><code>testing.set_fail_timeout</code></a></li><li><a href=#testingfail><code>testing.fail</code></a></li><li><a href=#testingfail_now><code>testing.fail_now</code></a></li><li><a href=#tseed><code>T.seed</code></a></li></ul></li><li><a href=#separating-tests>Separating Tests</a></li><li><a href=#multiple-packages>Multiple Packages</a></li><li><a href=#compile-time-options>Compile-Time Options</a></li><li><a href=#final-notes>Final Notes</a></li></ul></nav></div></div></div></div></main><footer class=odin-footer><div class="container pb-5 pt-5"><div class="row g-4"><div class=col><a class=navbar-brand href=/><img class=mb-3 src=/logo.svg height=30 alt=Odin></a><p>The Data-Oriented Language for Sane Software Development.</p></div><nav class=col-md-auto><h4 class=fw-normal>Resources</h4><ul class=list-unstyled><li><a href=/docs class=link-light>Docs</a></li><li><a href=https://pkg.odin-lang.org/ class=link-light>Packages</a></li><li><a href=/news class=link-light>News</a></li></ul></nav><nav class=col-md-auto><h4 class=fw-normal>Community</h4><ul class=list-unstyled><li><a href=https://github.com/odin-lang/Odin target=_blank class=link-light>GitHub</a></li><li><a href=https://discord.gg/vafXTdubwr target=_blank class=link-light>Discord</a></li><li><a href=https://www.twitch.tv/ginger_bill target=_blank class=link-light>Twitch</a></li><li><a href=https://www.youtube.com/channel/UCUSck1dOH7VKmG4lRW7tZXg target=_blank class=link-light>YouTube</a></li><li><a href=/showcase target=_blank class=link-light>Showcase</a></li></ul></nav><nav class=col-md-auto><h4 class=fw-normal>Contribute</h4><ul class=list-unstyled><li><a href=https://github.com/odin-lang/Odin/issues target=_blank class=link-light>Issues</a></li><li><a href=https://www.patreon.com/gingerbill target=_blank class=link-light>Donate</a></li></ul></nav></div><div class="mt-4 text-muted">© 2016–2024 Ginger Bill</div></div></footer><script src=/lib/bootstrap/js/bootstrap.min.js></script><script src=/js/script.js></script></body></html>